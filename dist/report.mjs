var C=Object.defineProperty,M=(t,e,n)=>e in t?C(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,g=(t,e,n)=>(M(t,typeof e!="symbol"?e+"":e,n),n);import{Assertion as L}from"./assert.mjs";import"dequal";import"diff";const T="uvub-report:ready",R=new Intl.NumberFormat([],{maximumFractionDigits:2,minimumFractionDigits:2,style:"unit",unit:"millisecond",unitDisplay:"short"}),H=t=>t.trim();function x(t){const e=t?.indexOf(`
`)??-1;return e<0?"":t.substring(e).split(`
`).map(H).join(`
`)}function $(t){const[e,n,s]=t;let o="",i="",a="";return e instanceof Error?(e.name&&(o=e.name),e.message&&(o=o?`${o}: ${e.message}`:e.message),e instanceof L&&e.operator&&(i=e.operator),typeof e.stack=="string"&&(a=x(e.stack))):typeof e=="string"?o=e:o=String(e),{suiteName:s,testName:n,message:o,operator:i,stack:a}}function q(t){let e=t,n=[],s,o;const i=()=>{if(e!==void 0){for(const r of n)switch(r.kind){case"suite-start":e.renderSuiteStart(r.name);break;case"suite-test":e.renderSuiteTest(r.passed);break;case"suite-result":e.renderSuiteResult(r.selected,r.passed,r.skipped,r.errors.map($));break;case"end-result":{const c=`${r.endResult.total}`,u=`${r.endResult.done}`,l=`${r.endResult.skipped}`,d=R.format(r.endResult.duration);e.renderSummary({withErrors:r.endResult.withErrors,withSkips:r.endResult.skipped>0,total:c,passed:u,skipped:l,duration:d});break}}s=void 0,n.length=0}},a=()=>{s||(s=setTimeout(i))};return{suiteStart(r){e!==void 0&&(n.push({kind:"suite-start",name:r}),a())},suiteResult(r,c,u,l){console.log("suiteResult",r,c,u,l),e!==void 0&&(n.push({kind:"suite-result",selected:c,passed:u,skipped:l,errors:r}),a())},testPass(){e!==void 0&&(n.push({kind:"suite-test",passed:!0}),a())},testFail(){e!==void 0&&(n.push({kind:"suite-test",passed:!1}),a())},result(r){e!==void 0&&(n.push({kind:"end-result",endResult:r}),a())},isAttached(){return e!==void 0},onDetach(r){o=r},detach(){s&&clearTimeout(s),s=void 0,n.length=0,e=void 0,o&&o(),o=void 0}}}function m(t){const e=document.getElementById(t);if(!(e instanceof HTMLTemplateElement))throw new Error("${id} template not found");return e}const N="uvub-report-suite";let f;function j(t,e){if(!f){const r=m(N).content.firstElementChild;if(!(r instanceof HTMLTableRowElement))throw new Error("prepareSuite: Incorrect root type");f=r}const n=f.cloneNode(!0),s=n.querySelector("th"),o=n.querySelector(".js-uvb-report-test-count"),i=n.querySelector(".js-uvb-report-test-indicator");if(!(s instanceof HTMLTableCellElement&&o instanceof HTMLTableCellElement&&i instanceof HTMLTableCellElement))throw new Error("prepareSuite: Missing references");const a=`suite${e}`;return s.setAttribute("id",a),s.textContent=t,o.headers=a,i.headers=a,{root:n,header:s,count:o,indicators:i,id:a,outcomes:[]}}function A(t,e){t.outcomes.push(e?"\u2022":"\u2718");const n=t.outcomes.join(" ");t.indicators.innerHTML=n}function F(t,e,n,s,o){t.count.textContent=`(${n}/${e})`;const i=o>0?"uvb-report--fail":s>0?"uvb-report--skip":"uvb-report--pass";t.count.classList.add(i)}const I="uvub-report-failure";let b;function D(t,e,n,s,o){var i;if(!b){const d=m(I).content.firstElementChild;if(!(d instanceof HTMLTableSectionElement))throw new Error("renderTestFailure: Incorrect root type");b=d}const a=b.cloneNode(!0),r=a.querySelector("th"),c=a.querySelector("td"),u=a.querySelector("span");if(!(r instanceof HTMLTableCellElement&&c instanceof HTMLTableCellElement&&u instanceof HTMLSpanElement))throw new Error("renderTestFailure: Missing references");const l=`fail${n}`;if(r.textContent=t,r.setAttribute("id",l),c.headers=`suite${e} ${l}`,o){u.textContent=`(${o})`;const d=document.createTextNode(`${s} `);(i=u.parentNode)==null||i.insertBefore(d,u)}else c.textContent=s;return Array.from(a.children)}const P="uvub-report-error";let h;function U(t,e,n){if(!h){const a=m(P).content.firstElementChild;if(!(a instanceof HTMLTableRowElement))throw new Error("renderErrorStack: Incorrect root type");h=a}const s=h.cloneNode(!0),o=s.querySelector("td"),i=s.querySelector("pre");if(!(o instanceof HTMLTableCellElement&&i instanceof HTMLPreElement))throw new Error("renderErrorStack: Missing references");return o.headers=`suite${t} fail${e}`,i.textContent=n,s}const B="uvub-report-summary";let v;function y(){if(!v){const r=m(B).content.firstElementChild;if(!(r instanceof HTMLTableElement))throw new Error("prepareSummary: Incorrect root type");v=r}const t=v.cloneNode(!0),e=t.querySelector(".js-uvb-report-total"),n=t.querySelector(".js-uvb-report-passed"),s=t.querySelector(".js-uvb-report-skipped"),o=t.querySelector(".js-uvb-report-duration"),i=t.querySelector("tbody");if(!(e instanceof HTMLTableCellElement&&n instanceof HTMLTableCellElement&&s instanceof HTMLTableCellElement&&o instanceof HTMLTableCellElement&&i instanceof HTMLTableSectionElement))throw new Error("prepareSummary: Missing references");const a=n.parentElement;if(!(a instanceof HTMLTableRowElement))throw new Error("prepareSummary: Missing references 2");return{root:t,total:e,passedRow:a,passed:n,skipped:s,duration:o,tbody:i}}function O(t,e){const{total:n,passed:s,passedRow:o,skipped:i,duration:a}=t;n.textContent=e.total,s.textContent=e.passed;const r=o.classList;e.withErrors?(r.remove("uvb-report--pass"),r.add("uvb-report--fail")):(r.remove("uvb-report--fail"),r.add("uvb-report--pass")),i.textContent=e.skipped;const c=i.classList;e.withSkips?c.add("uvb-report--skip"):c.remove("uvb-report--skip"),a.textContent=e.duration}function _(t){let e=!1,n=0,s=0,o,i=y();t(i.root);const a={resetSummary(){e=!1,n=0,i=y(),t(i.root)},renderSuiteStart(u){e&&a.resetSummary(),o=j(u,n),i.tbody.append(o.root),n+=1},renderSuiteTest(u){if(o===void 0)throw new Error("renderSuiteTest: expected suite");A(o,u)},renderSuiteResult(u,l,d,E){if(o===void 0)throw new Error("renderSuiteTest: expected suite");F(o,u,l,d,E.length);for(const p of E){const w=D(p.testName,n,s,p.message,p.operator);if(i.tbody.append(...w),p.stack){const k=U(n,s,p.stack);i.tbody.append(k)}s+=1}},renderSummary(u){e=!0,i!==void 0&&O(i,u)}};let r;const c={detach(){r&&(r.detach(),r=void 0)},get reporter(){return c.detach(),r=q(a),r}};return c}class S extends CustomEvent{constructor(e){super(T,{bubbles:!0,detail:e})}get reporter(){return this.detail.reporter}}class J extends HTMLElement{constructor(){super(),g(this,"binder"),this.binder=_(e=>{this.replaceChildren(e)})}connectedCallback(){this.isConnected&&this.dispatchEvent(new S(this.binder))}disconnectedCallback(){this.binder.detach()}}export{T as UVUB_REPORT_READY,J as UvubReport,S as UvubReportReadyEvent};
